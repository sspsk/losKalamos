{% extends '/base.html' %}
{% block title %} entries {% endblock %}
{% block myscript %}
<script >
  var latest;
  $(document).ready(function(){
    latest = {{latest_id[0]}};
    longPoll()
  });
  function longPoll(){
    $.ajax({
        url: $SCRIPT_ROOT+"/entriesUpdate?last="+latest,
        success: function(data){
            for(let i =0;i<data.length;i++){
              $("#nottaken").append(' <li class="list-group-item"><div class="row"><div class="col-10"><p>Type: '+data[i][1]+'. Region: '+data[i][2]+'. Area: '+data[i][3]+'. Address: '+data[i][4]+'. Details: '+data[i][5]+'. Available to take. </p></div><div class="col"><form method="post" action="'+$SCRIPT_ROOT+'/'+data[i][0]+'/take"><input type="submit" class="btn btn-primary" value="Take"></form></div></div></li>');
            }
            latest = data[data.length-1][0];
        },
        type: "GET",
        dataType: "json",
        complete: longPoll,
        timeout: 60000 // timeout every one minute
    });
}
</script>
{% endblock %}

{% block content %}


<div class="container">


<ul class="nav">
    <li class="nav-item">
    <a class="nav-link" >Signed in as {{ g.user['username']}}</a>
   </li>
   <li class="nav-item">
    <a class="nav-link" href="{{url_for('auth.logout')}}">Logout</a>
  </li>
</ul>


{% for message in get_flashed_messages() %}
  <div class="alert alert-info" role="alert">{{ message }}</div>

{% endfor %}
  {% if g.user['type'] == "admin" %}
  <div class="row justify-content-center">
  <div class="col-6 ">
    <form method="post" action="{{url_for('auth.register')}}">
      <div class="form-group">
        <p class="h4 mb-4 text-center" >Register a technician.</p>
      </div>
      <div class="form-group">
     <input type="text" id="defaultLoginFormUsername" class="form-control mb-4" placeholder="Username" name="username" required>
     </div>
     <div class="form-group">
     <input type="text" id="defaultLoginFormUsername" class="form-control mb-4" placeholder="Password" name="password" required>
     </div>
     <div class="form-group text-center">
     <select class="form-control"  name="type">
       <option selected disabled>Type</option>
         <option>Water</option>
         <option>Road</option>
         <option>Electricity</option>
         <option>admin</option>
      </select>
      </div>
      <div class="form-group">
      <select class="form-control"  name="region" >
        <option selected disabled>Region</option>
        {% for region in regions %}
        <option>{{region['name']}}</option>
        {%endfor%}
        <option>admin</option>
      </select>
      </div>
      <div class="form-group">
     <input type="submit" class="btn btn-info btn-block my-4 primary" value="Register">
     </div>
    </form>
    <form method="post" action="{{url_for('auth.addregion')}}">
      <div class="form-group">
        <p class="h4 mb-4 text-center" >Add a region.</p>
      </div>
      <div class="form-group">
     <input type="text" id="defaultLoginFormUsername" class="form-control mb-4" placeholder="Region" name="region" required>
     </div>
     <div class="form-group">
    <input type="submit" class="btn btn-info btn-block my-4 primary" value="Add">
    </div>
    </form>
    <form method="post" action="{{url_for('auth.addarea')}}">
      <div class="form-group">
        <p class="h4 mb-4 text-center" >Add an area.</p>
      </div>
      <div class="form-group">
      <select class="form-control"  name="region" >
        <option selected disabled>Region</option>
        {% for region in regions %}
        <option>{{region['name']}}</option>
        {%endfor%}
      </select>
      </div>
      <div class="form-group">
     <input type="text" id="defaultLoginFormUsername" class="form-control mb-4" placeholder="Area" name="area" required>
     </div>
     <div class="form-group">
    <input type="submit" class="btn btn-info btn-block my-4 primary" value="Add">
    </div>
    </form>
    <form method="get" >
      <div class="form-group">
        <p class="h4 mb-4 text-center" >Search by id</p>
      </div>
      <div class="form-group">
     <input type="text" id="defaultLoginFormUsername" class="form-control mb-4" placeholder="Report id" name="report_id" required>
     </div>
     <div class="form-group">
    <input type="submit" class="btn btn-info btn-block my-4 primary" value="Search">
    </div>
    </form>
    <form method="get" >
      <div class="form-group">
        <input type="submit" class="btn btn-info btn-block my-4 primary" value="Show all">
     </div>
    </form>
    </div>
    </div>
  {% endif %}


  <ul class="list=group" id="nottaken">
  <p>Available reports</p>
  {% for post in postsnottaken %}
    <li class="list-group-item">
      <div class="row">
        <div class="col-10">
        <p>Type: {{ post['type'] }}. Region: {{post['region']}}. Area: {{post['area']}}. Address: {{post['address']}}. Details: {{post['description']}}. Available to take. </p>
        </div>
        <div class="col">
      <form method="post" action="{{url_for('reports.take', id = post['id'])}}">
      <input type="submit" class="btn btn-primary" value="Take">
      </form>
      </div>
      </div>
    </li>
  {% endfor %}
  </ul>
  <ul class="list=group">
  <p>My reports</p>
  {% for post in poststaken %}
    <li class="list-group-item">
      <div class="row">
        <div class="col-8">
      <p>Type: {{ post['type'] }}. Region: {{post['region']}}. Area: {{post['area']}}. Address: {{post['address']}}. Details: {{post['description']}}. Taken by: {{post['username']}}</p>
      </div>
      {% if post['takenby'] == g.user['id'] %}
      <div class="col-2">
      <form method="post" action="{{url_for('reports.delete', id = post['id'])}}">
      <input type="submit" class="btn btn-danger" value="Delete">
      </form>
      </div>
      <div class="col-2">
      <form method="post" action="{{url_for('reports.undo', id = post['id'])}}">
      <input type="submit" class="btn btn-info" value="Undo">
      </form>
      </div>
      {% endif %}
      </div>
    </li>
  {% endfor %}
  </ul>
  </div>


{% endblock %}
