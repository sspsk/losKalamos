{% extends '/base.html' %}
{% block title %} entries {% endblock %}
{% block myscript %}
<script >
  $(document).ready(function(){ //function to return corresponding areas of a region
    $("#regionSelector").change(function(){
      $.getJSON($SCRIPT_ROOT + '/getareas',{region : $(this).val()},function(data){
          $("#areaSelector").empty();
          $("#areaSelector").append('<option selected disabled>Υποπεριοχή</option>');
        for(let i =0;i<data.length;i++){
          $("#areaSelector").append('<option>'+data[i][1]+'</option>');
        }
      });
    });
  });
  var prevId ;
  function search(arg) {

    $.getJSON($SCRIPT_ROOT+'/entries',{report_id : arg},function(data){

      if(data[0] != null){
        $("#searchRes").empty();
        $("#searchTable").removeAttr('hidden');
        console.log(data[0]);
        var html = `
        <tr data-id="${data[0][0]}">
          <td>${data[0][0]}</td>
          <td>${data[0][1]}</td>
          <td>${data[0][3]}</td>
          <td>${data[0][2]}</td>
          <td>${data[0][4]}</td>



        `;
        if(data[0][6] ==true){
          html += `
          <td>${data[0][9]}</td>
          <td>Ολοκληρώθηκε απο: ${data[0][8]}</td>
          <td>-</td>
          `;
        }
        else{

          if(data[0][7] == null){

            html += `
            <td>${data[0][8]}</td>
            <td>Διαθέσιμο για αναλαβή</td>
            <td><form method="post" action="${$SCRIPT_ROOT+"/"+data[0][0]+"/take"}">
            <input type="submit" class="btn btn-primary" value="Αναλαβή">
            </form><td>
            `;
          }
          else{
            html += `<td>Αναλαβή απο: ${data[0][8]}</td> `;
            if(data[1] == data[0][7]){
              html += `
              <td>
              <div class="row">
              <div class="col">
              <form method="post" action="${$SCRIPT_ROOT+"/"+data[0][0]+"/done"}">
              <input type="submit" class="btn btn-danger" value="Ολοκλήρωση">
              </form>
              </div>
              <div class="col">
              <form method="post" action="${$SCRIPT_ROOT+"/"+data[0][0]+"/undo"}">
              <input type="submit" class="btn btn-info" value="Απόριψη">
              </form>
              </div>
            </div>
            </td>
              `;
            }
            else{
              html += `<td>-</td>`;
            }
          }
        }
        html += `</tr>
        <tr>
          <td colspan="5"><b>Περιγραφή:</b> ${data[0][5]}</td>
          <td colspan="3"><b>Ονοματεπώνυμο:</b> ${data[0][9]}</td>
        </tr>
        `;

        $("#searchRes").append(html);
      }
    });
    prevId = arg;
  }
  function longPolling(){
    $.ajax({
      url : $SCRIPT_ROOT + '/update',
      data :{ onLeave : false},
      dataType: 'json',
      success : function(data){
        if(data != null) {
          if(prevId != undefined){
            search(prevId);
          }
          $("#taken").empty();
          $("#nottaken").empty();
          $("#completed").empty();
          if(data[0] != null){
            for(let i =0;i<data[0].length;i++){

               var html = `
               <tr data-id="${data[0][i][0]}">
                 <td>${data[0][i][0]}</td>
                 <td>${data[0][i][1]}</td>
                 <td>${data[0][i][3]}</td>
                 <td>${data[0][i][2]}</td>
                 <td>${data[0][i][4]}</td>
                 <td>${data[0][i][8]}</td>
                 <td>Αναλαβή απο: ${data[0][i][7]}</td>
                 `;
                 if(data[2] == data[0][i][6]){
                   html += `
                   <td>
                   <div class="row">
                   <div class="col">
                   <form method="post" action="${$SCRIPT_ROOT+"/"+data[0][i][0]+"/done"}">
                   <input type="submit" class="btn btn-danger" value="Ολοκλήρωση">
                   </form>
                   </div>
                   <div class="col">
                   <form method="post" action="${$SCRIPT_ROOT+"/"+data[0][i][0]+"/undo"}">
                   <input type="submit" class="btn btn-info" value="Απόριψη">
                   </form>

                   </div>
                 </div>
                 </td>
                   `;
                 }
                 else{
                   html += `
                   <td>-</td>`;
                 }

                html += `
                </tr>
                <tr>
                  <td colspan="5"><b>Περιγραφή:</b> ${data[0][i][5]}</td>
                  <td colspan="3"><b>Ονοματεπώνυμο:</b> ${data[0][i][9]}</td>
                </tr>
                `;
             $("#taken").append(html);

               }
          }
          if(data[1] != null){
            for(let i =0;i<data[1].length;i++){
              var html = `
                <tr data-id="${data[1][i][0]}">
                  <td>${data[1][i][0]}</td>
                  <td>${data[1][i][1]}</td>
                  <td>${data[1][i][3]}</td>
                  <td>${data[1][i][2]}</td>
                  <td>${data[1][i][4]}</td>
                  <td>${data[1][i][6]}</td>
                  <td>Διαθέσιμο για αναλαβή</td>
                  <td><form method="post" action="${$SCRIPT_ROOT+"/"+data[1][i][0]+"/take"}">
                  <input type="submit" class="btn btn-primary" value="Αναλαβή">
                  </form><td>
                </tr>
                <tr>
                  <td colspan="5"><b>Περιγραφή:</b> ${data[1][i][5]}</td>
                  <td colspan="3"><b>Ονοματεπώνυμο:</b> ${data[1][i][7]}</td>
                </tr>
                    `;
              $("#nottaken").append(html);
                }
               }
               if(data[3] != null){
                 for(let i =0;i<data[3].length;i++){

                    var html = `
                    <tr data-id="${data[3][i][0]}">
                      <td>${data[3][i][0]}</td>
                      <td>${data[3][i][1]}</td>
                      <td>${data[3][i][3]}</td>
                      <td>${data[3][i][2]}</td>
                      <td>${data[3][i][4]}</td>
                      <td>${data[3][i][8]}</td>
                      <td>Αναλαβή απο: ${data[3][i][7]}</td>
                      `;
                      html += `
                        <td>-</td>`;
                      html += `
                     </tr>
                     <tr>
                       <td colspan="5"><b>Περιγραφή:</b> ${data[3][i][5]}</td>
                       <td colspan="3"><b>Ονοματεπώνυμο:</b> ${data[3][i][9]}</td>
                     </tr>
                     `;
                  $("#completed").append(html);

                    }
               }
          }
          console.log(data);


      },
      error:function(jqXHR, textStatus, errorThrown){
        if(textStatus==="timeout") {
          console.log('timeout');
        }
      },
      complete : longPolling,
      timeout : 30000
    });


      }
  $(document).ready(function(){
    if(sessionStorage.getItem("pos") != undefined){
    window.scrollTo(0, sessionStorage.getItem("pos"));
    console.log(sessionStorage.getItem("pos"));
  }
    $(window).on("beforeunload",function(){  $.getJSON($SCRIPT_ROOT+'/update',{onLeave : true},function(data){});sessionStorage.setItem("pos",window.pageYOffset);});
    setTimeout(function(){longPolling();},4000);
    $("#searchBtn").click(function(){
        var arg = $("#searchText").val();
        search(arg);
    });


    $("#cancelBtn").on("click",function(){
      $("#searchRes").empty();
      $("#searchTable").attr("hidden",true);
      prevId = undefined;
    });

  });


</script>
{% endblock %}

{% block content %}


<div class="container">


<ul class="nav bg-light rounded" id="myNav">
    <li class="nav-item">
    <a class="nav-link" >Είστε συνδεδεμένος ως {{ g.user['username']}}</a>
   </li>
   <li class="nav-item">
    <a class="nav-link" href="{{url_for('auth.logout')}}">Αποσύνδεση</a>
  </li>
</ul>


{% for message in get_flashed_messages() %}
  <div class="alert alert-info" role="alert">{{ message }}</div>

{% endfor %}
  {% if g.user['type'] == "admin"  %}
  <div class="row justify-content-center">
  <div class="col-5 bg-light rounded" id="entriesForm">
    <form  class="bg-light rounded"method="post" action="{{url_for('auth.register')}}">
      <div class="form-group">
        <p class="h4 mb-4 text-center" >Δημιουργία τεχνικού</p>
      </div>
      <div class="form-group">
     <input type="text" id="defaultLoginFormUsername" class="form-control mb-4" placeholder="Συνθηματικο" name="username" required>
     </div>
     <div class="form-group">
     <input type="text" id="defaultLoginFormUsername" class="form-control mb-4" placeholder="Κωδικός" name="password" required>
     </div>
     <div class="form-group text-center">
     <select class="form-control"  name="type">
       <option selected disabled>Είδος εργασίας</option>
         <option>Ύδρευση</option>
         <option>Οδόστρωμα</option>
         <option>Ηλεκτροφωτισμός</option>
         <option>Καθαριότητα</option>
         <option>admin</option>
      </select>
      </div>
      <div class="form-group">
      <select class="form-control"  name="region" >
        <option selected disabled>Κοινότητα</option>
        {% for region in regions %}
        <option>{{region['name']}}</option>
        {%endfor%}
        <option>admin</option>
      </select>
      </div>
      <div class="form-group">
     <input type="submit" class="btn btn-info btn-block my-4 primary" value="Δημιουργια">
     </div>
    </form>
    </div>
    <div class="col-3 bg-light rounded" id="entriesForm">
    <div class="row justify-content-center">
    <form  class="bg-light rounded" method="post" action="{{url_for('auth.addregion')}}">
      <div class="form-group">
        <p class="h4 mb-4 text-center" >Πρόσθεση κοινότητας</p>
      </div>
      <div class="form-group">
     <input type="text" id="defaultLoginFormUsername" class="form-control mb-4" placeholder="Κοινοτητα" name="region" required>
     </div>
     <div class="form-group">
    <input type="submit" class="btn btn-info btn-block my-4 primary" value="Προσθεση">
    </div>
    </form>
    </div>
    {% if g.user['region'] == "admin" %}
    <div class="row justify-content-center">
    <form  class="bg-light rounded" method="post" action="{{url_for('auth.delRegion')}}">
      <div class="form-group">
        <p class="h4 mb-4 text-center" >Διαγραφή κοινότητας</p>
        <div class="form-group">
        <select class="form-control"  name="region" >
          <option selected disabled>Κοινότητα</option>
          {% for region in regions %}
          <option>{{region['name']}}</option>
          {%endfor%}
        </select>
        </div>
     <div class="form-group">
    <input type="submit" class="btn btn-danger btn-block my-4 primary" value="Διαγραφή">
    </div>
    </form>
    </div>
    {% endif %}
    </div>
    <div class="col-3 bg-light rounded" id="entriesForm">
    <div class="row justify-content-center">
    <form  class="bg-light rounded" method="post" action="{{url_for('auth.addarea')}}">
      <div class="form-group">
        <p class="h4 mb-4 text-center" >Πρόσθεση περιοχής</p>
      </div>
      <div class="form-group">
      <select class="form-control"  name="region" >
        <option selected disabled>Κοινότητα</option>
        {% for region in regions %}
        <option>{{region['name']}}</option>
        {%endfor%}
      </select>
      </div>
      <div class="form-group">
     <input type="text" id="defaultLoginFormUsername" class="form-control mb-4" placeholder="Περιοχη" name="area" required>
     </div>
     <div class="form-group">
    <input type="submit" class="btn btn-info btn-block my-4 primary" value="Πρόσθεση">
    </div>
    </form>
    </div>
    {% if g.user['region'] == "admin" %}
    <div class="row justify-content-center">
    <form  class="bg-light rounded" method="post" action="{{url_for('auth.delArea')}}">
      <div class="form-group">
        <p class="h4 mb-4 text-center" >Διαγραφή περιοχής</p>
      </div>
      <div class="form-group">
      <select class="form-control" id="regionSelector" name="region" >
        <option selected disabled>Κοινότητα</option>
        {% for region in regions %}
        <option>{{region['name']}}</option>
        {%endfor%}
      </select>
      </div>
      <div class="form-group">
        <select id="areaSelector" class="form-control"  name="area" >
          <option selected disabled>Περιοχή</option>
        </select>
     </div>
     <div class="form-group">
    <input type="submit" class="btn btn-danger btn-block my-4 primary" value="Διαγραφή">
    </div>
    </form>
    </div>
    {%endif%}
    </div>
    </div>
    <div class="row d-flex justify-content-center">
      <div class="col-5">
          <input  id="searchText" class="form-control rounded" type="text" placeholder="Ιd αναφορας" aria-label="Search" required>
          <button id="searchBtn" class="btn btn-info btn-rounded btn-sm my-0" type="submit">Αναζήτηση</button>
          <button id="cancelBtn" class="btn btn-info btn-rounded btn-sm my-0" type="submit">Αφαίρεση αναζήτησης</button>

      </div>
    </div>

    <table id="searchTable" class="table table-striped bg-light rounded" hidden>
      <thead>
        <tr>
          <th>Τύπος βλάβης</th>
          <th>Κοινότητα</th>
          <th>Περιοχή</th>
          <th>Διεύθυνση</th>
          <th>Καταχωρήθηκε</th>
          <th>Κατάσταση</th>
          <th>Δράση</th>
          <th
        </tr>
      </thead>
      <tbody id="searchRes">

      </tbody>
    </table>


  {% endif %}

<div class="d-flex justify-content-center">
  <h3>Διαθέσιμες αναφορές</h3>
  </div>


  <table colspan="8" class="table table-striped bg-light rounded">
    <thead>
      <tr>
        <th>A/A</th>
        <th>Τύπος βλάβης</th>
        <th>Κοινότητα</th>
        <th>Περιοχή</th>
        <th>Διεύθυνση</th>
        <th>Καταχωρήθηκε</th>
        <th>Κατάσταση</th>
        <th>Δράση</th>

      </tr>
    </thead>
    <tbody id="nottaken" >
      {% for post in postsnottaken %}
      <tr data-id="{{post['id']}}" class="tableRow">
        <td>{{ post['id'] }}</td>
        <td >{{ post['type'] }}</td>
        <td>{{post['region']}}</td>
        <td>{{post['area']}}</td>
        <td>{{post['address']}}</td>
        <td>{{post['created']}}</td>
        <td>Διαθέσιμο για αναλαβή</td>
        <td><form method="post" action="{{url_for('reports.take', id = post['id'])}}">
        <input id="take"type="submit" class="btn btn-primary" value="Αναλαβή">
        </form></td>
      </tr>
      <tr>
        <td colspan="5" maxlength="40"><b>Περιγραφή:</b> {{post['description']}}</td>
        <td colspan="3"><b>Ονοματεπώνυμο:</b> {{post['contact_name']}}</td>
      </tr>
      {% endfor %}

    </tbody>
  </table>
  <div class="container" align="left">
		<a href="/downloads?posts=nottaken" target="blank"><button class='btn-info btn-default'>Download</button></a>
   </div>

  <div class="d-flex justify-content-center">
    <h3>Αναφορές υπο αναλαβή</h3>
    </div>

    <table colspan="8" class="table table-striped bg-light rounded">
      <thead>
        <tr>
          <th>A/A</th>
          <th>Τύπος βλάβης</th>
          <th>Κοινότητα</th>
          <th>Περιοχή</th>
          <th>Διεύθυνση</th>
          <th>Καταχωρήθηκε</th>
          <th>Κατάσταση</th>
          <th>Δράση</th>

        </tr>
      </thead>
      <tbody id="taken" >
        {% for post in poststaken %}
        <tr data-id="{{post['id']}}" class="tableRow">
          <td >{{ post['id'] }}</td>
          <td>{{ post['type'] }}</td>
          <td>{{post['region']}}</td>
          <td>{{post['area']}}</td>
          <td>{{post['address']}}</td>
          <td>{{post['created']}}</td>
          <td>Αναλαβή απο: {{post['username']}}</td>
          {% if post['takenby'] == g.user['id'] %}
          <td>
          <div class="row">
          <div class="col">
          <form method="post" action="{{url_for('reports.done', id = post['id'])}}">
          <input type="submit" class="btn btn-danger" value="Ολοκλήρωση">
          </form>
          </div>
          <div class="col">
          <form method="post" action="{{url_for('reports.undo', id = post['id'])}}">
          <input type="submit" class="btn btn-info" value="Απόριψη">
          </form>
          </div>
          </div>
          </td>
          {%else%}
          <td>-</td>
          {%endif%}
        </tr>
        <tr>
          <td colspan="5"><b>Περιγραφή:</b> {{post['description']}}</td>
          <td colspan="3"><b>Ονοματεπώνυμο:</b> {{post['contact_name']}}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    <div class="container" align="left">
  		<a href="/downloads?posts=taken" target="blank"><button class='btn-info btn-default'>Download</button></a>
     </div>
     {% if g.user['type'] == "admin" %}
     <div class="d-flex justify-content-center">
       <h3>Ολοκληρωθήσες αναφορές</h3>
       </div>

       <table colspan="8" class="table table-striped bg-light rounded">
         <thead>
           <tr>
             <th>A/A</th>
             <th>Τύπος βλάβης</th>
             <th>Κοινότητα</th>
             <th>Περιοχή</th>
             <th>Διεύθυνση</th>
             <th>Καταχωρήθηκε</th>
             <th>Κατάσταση</th>
             <th>Δράση</th>

           </tr>
         </thead>
         <tbody id="completed" >
           {% for post in postscompleted %}
           <tr data-id="{{post['id']}}" class="tableRow">
             <td >{{ post['id'] }}</td>
             <td>{{ post['type'] }}</td>
             <td>{{post['region']}}</td>
             <td>{{post['area']}}</td>
             <td>{{post['address']}}</td>
             <td>{{post['created']}}</td>
             <td>Ολοκληρώθηκε απο: {{post['username']}}</td>
             <td>-</td>
           </tr>
           <tr>
             <td colspan="5"><b>Περιγραφή:</b> {{post['description']}}</td>
             <td colspan="3"><b>Ονοματεπώνυμο:</b> {{post['contact_name']}}</td>
           </tr>
           {% endfor %}
         </tbody>
       </table>
       <div class="container" align="left">
     		<a href="/downloads?posts=completed" target="blank"><button class='btn-info btn-default'>Download</button></a>
        </div>
  </div>
  {%endif%}


{% endblock %}
