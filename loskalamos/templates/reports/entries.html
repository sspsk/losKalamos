{% extends '/base.html' %}
{% block title %} entries {% endblock %}
{% block myscript %}
<script >

  function longPolling(){
      $.getJSON($SCRIPT_ROOT+'/update',{onLeave : false},function(data){
        if(data != null) {
          $("#taken").empty();
          $("#nottaken").empty();
          if(data[0] != null){
            for(let i =0;i<data[0].length;i++){
               var html = `
               <tr>
                 <td>${data[0][i][1]}</td>
                 <td>${data[0][i][3]}</td>
                 <td>${data[0][i][2]}</td>
                 <td>${data[0][i][4]}</td>
                 <td>Αναλαβη απο: ${data[0][i][7]}</td>
                 `;
                 if(data[2] == data[0][i][6]){
                   html += `
                   <td>
                   <div class="row">
                   <div class="col">
                   <form method="post" action="${$SCRIPT_ROOT+"/"+data[0][i][0]+"/delete"}">
                   <input type="submit" class="btn btn-danger" value="Διαγραφη">
                   </form>
                   </div>
                   <div class="col">
                   <form method="post" action="${$SCRIPT_ROOT+"/"+data[0][i][0]+"/undo"}">
                   <input type="submit" class="btn btn-info" value="Αποριψη">
                   </form>
                   </div>
                 </div>
                 </td>
                   `;
                 }
                 else{
                   html += `
                   <td>-</td>`;
                 }
                html += `
                </tr>
                <tr>
                  <td colspan="6"><b>Περιγραφη:</b> ${data[0][i][5]}</td>
                </tr>
                `;
             $("#taken").append(html);

               }
          }
          if(data[1] != null){
            for(let i =0;i<data[1].length;i++){
              var html = `
                <tr>
                  <td>${data[1][i][1]}</td>
                  <td>${data[1][i][3]}</td>
                  <td>${data[1][i][2]}</td>
                  <td>${data[1][i][4]}</td>
                  <td>Διαθεσιμο για αναλαβη</td>
                  <td><form method="post" action="${$SCRIPT_ROOT+"/"+data[1][i][0]+"/take"}">
                  <input type="submit" class="btn btn-primary" value="Αναλαβη">
                  </form><td>
                </tr>
                <tr>
                  <td colspan="6"><b>Περιγραφη:</b> ${data[1][i][5]}</td>
                </tr>
                    `;
              $("#nottaken").append(html);
                }
               }
          }
          console.log(data);
          longPolling();

      });

      }
  $(document).ready(function(){
    $(window).on("beforeunload",function(){  $.getJSON($SCRIPT_ROOT+'/update',{onLeave : true},function(data){});});
    setTimeout(function(){longPolling(); },4000);
    $("#searchBtn").click(function() {
      var arg = $("#searchText").val();
      $.getJSON($SCRIPT_ROOT+'/entries',{report_id : arg},function(data){
        if(data != null){
          $("#searchRes").empty();
          $("#searchTable").removeAttr('hidden');
          console.log(data[0]);
          var html = `
          <tr>
            <td>${data[0][1]}</td>
            <td>${data[0][3]}</td>
            <td>${data[0][2]}</td>
            <td>${data[0][4]}</td>


          `;
          if(data[0][6] ==true){
            html += `
            <td>Ολοκληρωθηκε απο: ${data[0][8]}</td>
            <td>-</td>
            `;
          }
          else{

            if(data[0][7] == null){

              html += `
              <td>Διαθεσιμο για αναλαβη</td>
              <td><form method="post" action="${$SCRIPT_ROOT+"/"+data[0][0]+"/take"}">
              <input type="submit" class="btn btn-primary" value="Αναλαβη">
              </form><td>
              `;
            }
            else{
              html += `<td>Αναλαβη απο: ${data[0][8]}</td> `;
              if(data[1] == data[0][7]){
                html += `
                <td>
                <div class="row">
                <div class="col">
                <form method="post" action="${$SCRIPT_ROOT+"/"+data[0][0]+"/done"}">
                <input type="submit" class="btn btn-danger" value="Ολοκληρωση">
                </form>
                </div>
                <div class="col">
                <form method="post" action="${$SCRIPT_ROOT+"/"+data[0][0]+"/undo"}">
                <input type="submit" class="btn btn-info" value="Αποριψη">
                </form>
                </div>
              </div>
              </td>
                `;
              }
              else{
                html += `<td>-</td>`;
              }
            }
          }
          html += `</tr>`;
          $("#searchRes").append(html);
        }
      });
    });




  });


</script>
{% endblock %}

{% block content %}


<div class="container">


<ul class="nav bg-light rounded" id="myNav">
    <li class="nav-item">
    <a class="nav-link" >Είστε συνδεδεμένος ως {{ g.user['username']}}</a>
   </li>
   <li class="nav-item">
    <a class="nav-link" href="{{url_for('auth.logout')}}">Αποσύνδεση</a>
  </li>
</ul>


{% for message in get_flashed_messages() %}
  <div class="alert alert-info" role="alert">{{ message }}</div>

{% endfor %}
  {% if g.user['type'] == "admin" %}
  <div class="row justify-content-center">
  <div class="col-5 bg-light rounded" id="entriesForm">
    <form  class="bg-light rounded"method="post" action="{{url_for('auth.register')}}">
      <div class="form-group">
        <p class="h4 mb-4 text-center" >Δημιουργια τεχνικου</p>
      </div>
      <div class="form-group">
     <input type="text" id="defaultLoginFormUsername" class="form-control mb-4" placeholder="Συνθηματικο" name="username" required>
     </div>
     <div class="form-group">
     <input type="text" id="defaultLoginFormUsername" class="form-control mb-4" placeholder="Κωδικός" name="password" required>
     </div>
     <div class="form-group text-center">
     <select class="form-control"  name="type">
       <option selected disabled>Είδος εργασίας</option>
         <option>Υδρευση</option>
         <option>Οδόστρωμα</option>
         <option>Ηλεκτροφωτισμος</option>
         <option>Καθαριοτητα</option>
         <option>admin</option>
      </select>
      </div>
      <div class="form-group">
      <select class="form-control"  name="region" >
        <option selected disabled>Κοινοτητα</option>
        {% for region in regions %}
        <option>{{region['name']}}</option>
        {%endfor%}
        <option>admin</option>
      </select>
      </div>
      <div class="form-group">
     <input type="submit" class="btn btn-info btn-block my-4 primary" value="Δημιουργια">
     </div>
    </form>
    </div>
    <div class="col-3 bg-light rounded" id="entriesForm">
    <form  class="bg-light rounded" method="post" action="{{url_for('auth.addregion')}}">
      <div class="form-group">
        <p class="h4 mb-4 text-center" >Πρόσθεση κοινοτητας</p>
      </div>
      <div class="form-group">
     <input type="text" id="defaultLoginFormUsername" class="form-control mb-4" placeholder="Κοινοτητα" name="region" required>
     </div>
     <div class="form-group">
    <input type="submit" class="btn btn-info btn-block my-4 primary" value="Προσθεση">
    </div>
    </form>
    </div>
    <div class="col-3 bg-light rounded" id="entriesForm">
    <form  class="bg-light rounded" method="post" action="{{url_for('auth.addarea')}}">
      <div class="form-group">
        <p class="h4 mb-4 text-center" >Πρόσθεση περιοχης</p>
      </div>
      <div class="form-group">
      <select class="form-control"  name="region" >
        <option selected disabled>Κοινοτητα</option>
        {% for region in regions %}
        <option>{{region['name']}}</option>
        {%endfor%}
      </select>
      </div>
      <div class="form-group">
     <input type="text" id="defaultLoginFormUsername" class="form-control mb-4" placeholder="Περιοχη" name="area" required>
     </div>
     <div class="form-group">
    <input type="submit" class="btn btn-info btn-block my-4 primary" value="Πρόσθεση">
    </div>
    </form>
    </div>
    </div>
    <div class="row d-flex justify-content-center">
      <div class="col-3">
          <input  id="searchText" class="form-control rounded" type="text" placeholder="Ιd αναφορας" aria-label="Search">
          <button id="searchBtn" class="btn btn-info btn-rounded btn-sm my-0" type="submit">Αναζητηση</button>
          <button id="showallBtn" class="btn btn-info btn-rounded btn-sm my-0" type="submit">Προβολη ολων</button>

      </div>
    </div>

    <table id="searchTable" class="table table-striped bg-light rounded" hidden>
      <thead>
        <tr>
          <th>Τυπος βλαβης</th>
          <th>Κοινοτητα</th>
          <th>Περιοχη</th>
          <th>Διευθυνση</th>
          <th>Κατασταση</th>
          <th>Δραση</th>
          <th
        </tr>
      </thead>
      <tbody id="searchRes">

      </tbody>
    </table>


  {% endif %}


<div class="d-flex justify-content-center">
  <h3>Διαθεσιμες αναφορες</h3>
  </div>
  <table></table>

  <table class="table table-striped bg-light rounded">
    <thead>
      <tr>
        <th>Τυπος βλαβης</th>
        <th>Κοινοτητα</th>
        <th>Περιοχη</th>
        <th>Διευθυνση</th>
        <th>Κατασταση</th>
        <th>Δραση</th>
        <th
      </tr>
    </thead>
    <tbody id="nottaken" >
      {% for post in postsnottaken %}
      <tr data-id="{{post['id']}}" class="tableRow">
        <td >{{ post['type'] }}</td>
        <td>{{post['region']}}</td>
        <td>{{post['area']}}</td>
        <td>{{post['address']}}</td>
        <td>Διαθεσιμο για αναλαβη</td>
        <td><form method="post" action="{{url_for('reports.take', id = post['id'])}}">
        <input id="take"type="submit" class="btn btn-primary" value="Αναλαβη">
        </form></td>
      </tr>
      <tr>
        <td colspan="6"><b>Περιγραφη:</b> {{post['description']}}</td>
      </tr>
      {% endfor %}

    </tbody>
  </table>

  <div class="d-flex justify-content-center">
    <h3>Αναφορες υπο αναλαβη</h3>
    </div>

    <table class="table table-striped bg-light rounded">
      <thead>
        <tr>
          <th>Τυπος βλαβης</th>
          <th>Κοινοτητα</th>
          <th>Περιοχη</th>
          <th>Διευθυνση</th>
          <th>Κατασταση</th>
          <th>Δραση</th>
          <th
        </tr>
      </thead>
      <tbody id="taken" >
        {% for post in poststaken %}
        <tr data-id="{{post['id']}}" class="tableRow">
          <td>{{ post['type'] }}</td>
          <td>{{post['region']}}</td>
          <td>{{post['area']}}</td>
          <td>{{post['address']}}</td>
          <td>Αναλαβη απο: {{post['username']}}</td>
          {% if post['takenby'] == g.user['id'] %}
          <td>
          <div class="row">
          <div class="col">
          <form method="post" action="{{url_for('reports.done', id = post['id'])}}">
          <input type="submit" class="btn btn-danger" value="Ολοκληρωση">
          </form>
          </div>
          <div class="col">
          <form method="post" action="{{url_for('reports.undo', id = post['id'])}}">
          <input type="submit" class="btn btn-info" value="Αποριψη">
          </form>
          </div>
          </div>
          </td>
          {% else %}
          <td>-</td>
          {% endif %}
        </tr>
        <tr>
          <td colspan="6"><b>Περιγραφη:</b> {{post['description']}}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

  </div>


{% endblock %}
