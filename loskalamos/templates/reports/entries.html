{% extends '/base.html' %}
{% block title %} entries {% endblock %}
{% block myscript %}
<script >

  var latest;

  $(document).ready(function(){
    console.log()
    longPoll();
  });

  function longPoll(){
    $.ajax({
        url: $SCRIPT_ROOT+"/entriesUpdate",
        success: function(data){
          console.log("my data: ")
          console.log(data);
          if(data != null) {
            $("#taken").empty();
            $("#nottaken").empty();
            if(data[0] != null){
              for(let i =0;i<data[0].length;i++){
                 var html = `
                 <tr>
                   <td>${data[0][i][1]}</td>
                   <td>${data[0][i][3]}</td>
                   <td>${data[0][i][2]}</td>
                   <td>${data[0][i][4]}</td>
                   <td>Αναλαβη απο: ${data[0][i][7]}</td>
                   `;
                   if(data[2] == data[0][i][6]){
                     html += `
                     <td>
                     <div class="row">
                     <div class="col">
                     <form method="post" action="${$SCRIPT_ROOT+"/"+data[0][i][0]+"/delete"}">
                     <input type="submit" class="btn btn-danger" value="Διαγραφη">
                     </form>
                     </div>
                     <div class="col">
                     <form method="post" action="${$SCRIPT_ROOT+"/"+data[0][i][0]+"/undo"}">
                     <input type="submit" class="btn btn-info" value="Αποριψη">
                     </form>
                     </div>
                   </div>
                   </td>
                     `;
                   }
                   else{
                     html += `
                     <td>-</td>`;
                   }
                  html += `
                  </tr>`;
               $("#taken").append(html);

                 }
            }
            if(data[1] != null){
              for(let i =0;i<data[1].length;i++){
                var html = `
                  <tr>
                    <td>${data[1][i][1]}</td>
                    <td>${data[1][i][3]}</td>
                    <td>${data[1][i][2]}</td>
                    <td>${data[1][i][4]}</td>
                    <td>Διαθεσιμο για αναλαβη</td>
                    <td><form method="post" action="${$SCRIPT_ROOT+"/"+data[1][i][0]+"/take"}">
                    <input type="submit" class="btn btn-primary" value="Αναλαβη">
                    </form><td>
                  </tr>
                      `;
                $("#nottaken").append(html);
                  }
                 }
            }


        },
        error: function(jqXhr, textStatus, errorMessage){
          console.log(errorMessage);
        },
        type: "GET",
        dataType: "json",
        complete: longPoll ,
        timeout: 120000 // ti1meout every 2 minutes,for safety reasons(request missing)
    });
  }
</script>
{% endblock %}

{% block content %}


<div class="container">


<ul class="nav bg-light rounded" id="myNav">
    <li class="nav-item">
    <a class="nav-link" >Είστε συνδεδεμένος ως {{ g.user['username']}}</a>
   </li>
   <li class="nav-item">
    <a class="nav-link" href="{{url_for('auth.logout')}}">Αποσύνδεση</a>
  </li>
</ul>


{% for message in get_flashed_messages() %}
  <div class="alert alert-info" role="alert">{{ message }}</div>

{% endfor %}
  {% if g.user['type'] == "admin" %}
  <div class="row justify-content-center">
  <div class="col-5 bg-light rounded" id="entriesForm">
    <form  class="bg-light rounded"method="post" action="{{url_for('auth.register')}}">
      <div class="form-group">
        <p class="h4 mb-4 text-center" >Δημιουργεια τεχνικου</p>
      </div>
      <div class="form-group">
     <input type="text" id="defaultLoginFormUsername" class="form-control mb-4" placeholder="Συνθηματικο" name="username" required>
     </div>
     <div class="form-group">
     <input type="text" id="defaultLoginFormUsername" class="form-control mb-4" placeholder="Κωδικός" name="password" required>
     </div>
     <div class="form-group text-center">
     <select class="form-control"  name="type">
       <option selected disabled>Είδος εργασίας</option>
         <option>Υδρευση</option>
         <option>Οδόστρωμα</option>
         <option>Ηλεκτροδότηση</option>
         <option>admin</option>
      </select>
      </div>
      <div class="form-group">
      <select class="form-control"  name="region" >
        <option selected disabled>Περιοχη</option>
        {% for region in regions %}
        <option>{{region['name']}}</option>
        {%endfor%}
        <option>admin</option>
      </select>
      </div>
      <div class="form-group">
     <input type="submit" class="btn btn-info btn-block my-4 primary" value="Δημιουργεια">
     </div>
    </form>
    </div>
    <div class="col-3 bg-light rounded" id="entriesForm">
    <form  class="bg-light rounded" method="post" action="{{url_for('auth.addregion')}}">
      <div class="form-group">
        <p class="h4 mb-4 text-center" >Πρόσθεση περιοχης</p>
      </div>
      <div class="form-group">
     <input type="text" id="defaultLoginFormUsername" class="form-control mb-4" placeholder="Περιοχη" name="region" required>
     </div>
     <div class="form-group">
    <input type="submit" class="btn btn-info btn-block my-4 primary" value="Προσθεση">
    </div>
    </form>
    </div>
    <div class="col-3 bg-light rounded" id="entriesForm">
    <form  class="bg-light rounded" method="post" action="{{url_for('auth.addarea')}}">
      <div class="form-group">
        <p class="h4 mb-4 text-center" >Πρόσθεση υποπεριοχής</p>
      </div>
      <div class="form-group">
      <select class="form-control"  name="region" >
        <option selected disabled>Περιοχη</option>
        {% for region in regions %}
        <option>{{region['name']}}</option>
        {%endfor%}
      </select>
      </div>
      <div class="form-group">
     <input type="text" id="defaultLoginFormUsername" class="form-control mb-4" placeholder="Υποπεριοχη" name="area" required>
     </div>
     <div class="form-group">
    <input type="submit" class="btn btn-info btn-block my-4 primary" value="Πρόσθεση">
    </div>
    </form>
    </div>
    </div>
    <div class="row d-flex justify-content-center bg-light rounded" id="entriesForm">
      <form class="form-inline" method="get" id="entriesForm">
        <div class="form-group">
          <label for="exampleInputName2" id="searchLabel"><b>Αναζητηση με Id</b></label>
          <input type="text" class="form-control" id="exampleInputName2" placeholder="Report id" name="report_id" required>
        </div>
        <div class="form-group">
          <input type="submit" class="btn btn-info btn-block my-4 primary" value="Αναζητηση">
       </div>
      </form>

    <form  class="form-inline " method="get" id="entriesForm">
      <div class="form-group">
        <input type="submit" class="btn btn-info btn-block my-4 primary" value="Προβολή όλων">
     </div>
    </form>

    </div>


  {% endif %}
<div class="d-flex justify-content-center">
  <h3>Διαθεσιμες αναφορες</h3>
  </div>


  <table class="table table-striped bg-light rounded">
    <thead>
      <tr>
        <th>Τυπος βλαβης</th>
        <th>Κοινοτητα</th>
        <th>Περιοχη</th>
        <th>Διευθυνση</th>
        <th>Κατασταση</th>
        <th>Δραση</th>
        <th
      </tr>
    </thead>
    <tbody id="nottaken" >
      {% for post in postsnottaken %}
      <tr>
        <td>{{ post['type'] }}</td>
        <td>{{post['region']}}</td>
        <td>{{post['area']}}</td>
        <td>{{post['address']}}</td>
        <td>Διαθεσιμο για αναλαβη</td>
        <td><form method="post" action="{{url_for('reports.take', id = post['id'])}}">
        <input id="take"type="submit" class="btn btn-primary" value="Αναλαβη">
        </form></td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  <div class="d-flex justify-content-center">
    <h3>Αναφορες υπο αναλαβη</h3>
    </div>

    <table class="table table-striped bg-light rounded">
      <thead>
        <tr>
          <th>Τυπος βλαβης</th>
          <th>Κοινοτητα</th>
          <th>Περιοχη</th>
          <th>Διευθυνση</th>
          <th>Κατασταση</th>
          <th>Δραση</th>
          <th
        </tr>
      </thead>
      <tbody id="taken" >
        {% for post in poststaken %}
        <tr>
          <td>{{ post['type'] }}</td>
          <td>{{post['region']}}</td>
          <td>{{post['area']}}</td>
          <td>{{post['address']}}</td>
          <td>Αναλαβη απο: {{post['username']}}</td>
          {% if post['takenby'] == g.user['id'] %}
          <td>
          <div class="row">
          <div class="col">
          <form method="post" action="{{url_for('reports.delete', id = post['id'])}}">
          <input type="submit" class="btn btn-danger" value="Διαγραφη">
          </form>
          </div>
          <div class="col">
          <form method="post" action="{{url_for('reports.undo', id = post['id'])}}">
          <input type="submit" class="btn btn-info" value="Αποριψη">
          </form>
          </div>
          </div>
          </td>
          {% else %}
          <td>-</td>
          {% endif %}
        </tr>
        {% endfor %}
      </tbody>
    </table>

  </div>


{% endblock %}
