{% extends '/base.html' %}
{% block title %} entries {% endblock %}
{% block myscript %}
<script >

  var latest;

  $(document).ready(function(){
    longPoll();
  });

  function longPoll(){
    $.ajax({
        url: $SCRIPT_ROOT+"/entriesUpdate",
        success: function(data){
          console.log("my data: ")
          console.log(data);
          if(data != null) {
            $("#taken").empty();
            $("#taken").append("<p>Available reports</p>");
            $("#nottaken").empty();
            $("#nottaken").append("<p>Taken reports</p>");
            if(data[0] != null){
              for(let i =0;i<data[0].length;i++){
               var html = `
               <li class="list-group-item">
                 <div class="row">
                 <div class="col-8">
                 <p>Type: ${data[0][i][1]}. Region: ${data[0][i][3]}. Area: ${data[0][i][2]}. Address: ${data[0][i][4]}. Details: ${data[0][i][5]}. Taken by: ${data[0][i][7]}</p>
                 </div>`;

                 if(data[2] == data[0][i][6]){
                   console.log(data[3] == data[0][i][6])
                   html += `
                   <div class="col-2">
                   <form method="post" action="${$SCRIPT_ROOT+"/"+data[0][i][0]+"/delete"}">
                   <input type="submit" class="btn btn-danger" value="Delete">
                   </form>
                   </div>
                   <div class="col-2">
                   <form method="post" action="${$SCRIPT_ROOT+"/"+data[0][i][0]+"/undo"}">
                   <input type="submit" class="btn btn-info" value="Undo">
                   </form>
                   </div>
                   `;
                 }
                 html += `
                 </div>
                 </li>
                 `;
               $("#taken").append(html);
                 }
            }
            if(data[1] != null){
              for(let i =0;i<data[1].length;i++){
                var html = `
                <li class="list-group-item">
                  <div class="row">
                  <div class="col-10">
                  <p>Type: ${data[1][i][1]}. Region: ${data[1][i][3]}. Area: ${data[1][i][2]}. Address: ${data[1][i][4]}. Details: ${data[1][i][5]}. Available to take</p>
                  </div>`;

                  html += `
                  <div class="col-2">
                  <form method="post" action="${$SCRIPT_ROOT+"/"+data[1][i][0]+"/take"}">
                  <input type="submit" class="btn btn-primary" value="Take">
                  </form>
                  </div>
                  `;

                  html += `
                  </div>
                  </li>
                  `;
                $("#nottaken").append(html);
                  }
                 }
            }


        },
        error: function(jqXhr, textStatus, errorMessage){
          console.log(errorMessage);
        },
        type: "GET",
        dataType: "json",
        complete: longPoll ,
        timeout: 120000 // ti1meout every 2 minutes,for safety reasons(request missing)
    });
  }
</script>
{% endblock %}

{% block content %}


<div class="container">


<ul class="nav bg-light rounded" id="myNav">
    <li class="nav-item">
    <a class="nav-link" >Είστε συνδεδεμένος ως {{ g.user['username']}}</a>
   </li>
   <li class="nav-item">
    <a class="nav-link" href="{{url_for('auth.logout')}}">Αποσύνδεση</a>
  </li>
</ul>


{% for message in get_flashed_messages() %}
  <div class="alert alert-info" role="alert">{{ message }}</div>

{% endfor %}
  {% if g.user['type'] == "admin" %}
  <div class="row justify-content-center">
  <div class="col-5 bg-light rounded" id="entriesForm">
    <form  class="bg-light rounded"method="post" action="{{url_for('auth.register')}}">
      <div class="form-group">
        <p class="h4 mb-4 text-center" >Δημιουργεια τεχνικου</p>
      </div>
      <div class="form-group">
     <input type="text" id="defaultLoginFormUsername" class="form-control mb-4" placeholder="Συνθηματικο" name="username" required>
     </div>
     <div class="form-group">
     <input type="text" id="defaultLoginFormUsername" class="form-control mb-4" placeholder="Κωδικός" name="password" required>
     </div>
     <div class="form-group text-center">
     <select class="form-control"  name="type">
       <option selected disabled>Είδος εργασίας</option>
         <option>Υδρευση</option>
         <option>Οδόστρωμα</option>
         <option>Ηλεκτροδότηση</option>
         <option>admin</option>
      </select>
      </div>
      <div class="form-group">
      <select class="form-control"  name="region" >
        <option selected disabled>Περιοχη</option>
        {% for region in regions %}
        <option>{{region['name']}}</option>
        {%endfor%}
        <option>admin</option>
      </select>
      </div>
      <div class="form-group">
     <input type="submit" class="btn btn-info btn-block my-4 primary" value="Δημιουργεια">
     </div>
    </form>
    </div>
    <div class="col-3 bg-light rounded" id="entriesForm">
    <form  class="bg-light rounded" method="post" action="{{url_for('auth.addregion')}}">
      <div class="form-group">
        <p class="h4 mb-4 text-center" >Πρόσθεση περιοχης</p>
      </div>
      <div class="form-group">
     <input type="text" id="defaultLoginFormUsername" class="form-control mb-4" placeholder="Περιοχη" name="region" required>
     </div>
     <div class="form-group">
    <input type="submit" class="btn btn-info btn-block my-4 primary" value="Προσθεση">
    </div>
    </form>
    </div>
    <div class="col-3 bg-light rounded" id="entriesForm">
    <form  class="bg-light rounded" method="post" action="{{url_for('auth.addarea')}}">
      <div class="form-group">
        <p class="h4 mb-4 text-center" >Πρόσθεση υποπεριοχής</p>
      </div>
      <div class="form-group">
      <select class="form-control"  name="region" >
        <option selected disabled>Περιοχη</option>
        {% for region in regions %}
        <option>{{region['name']}}</option>
        {%endfor%}
      </select>
      </div>
      <div class="form-group">
     <input type="text" id="defaultLoginFormUsername" class="form-control mb-4" placeholder="Υποπεριοχη" name="area" required>
     </div>
     <div class="form-group">
    <input type="submit" class="btn btn-info btn-block my-4 primary" value="Πρόσθεση">
    </div>
    </form>
    </div>
    </div>
    <div class="row d-flex justify-content-center bg-light rounded" id="entriesForm">
      <form class="form-inline" method="get" id="entriesForm">
        <div class="form-group">
          <label for="exampleInputName2" id="searchLabel"><b>Αναζητηση με Id</b></label>
          <input type="text" class="form-control" id="exampleInputName2" placeholder="Report id" name="report_id" required>
        </div>
        <div class="form-group">
          <input type="submit" class="btn btn-info btn-block my-4 primary" value="Αναζητηση">
       </div>
      </form>

    <form  class="form-inline " method="get" id="entriesForm">
      <div class="form-group">
        <input type="submit" class="btn btn-info btn-block my-4 primary" value="Προβολή όλων">
     </div>
    </form>

    </div>


  {% endif %}
<div class="d-flex justify-content-center">
  <h3>Διαθεσιμες αναφορες</h3>
  </div>

  <ul class="list=group" id="nottaken">

  {% for post in postsnottaken %}
    <li class="list-group-item rounded">
      <div class="row">
        <div class="col-10">
        <p>Τυπος βλαβης: {{ post['type'] }}. Περιοχη: {{post['region']}}. Υποπεριοχη: {{post['area']}}. Διευθυνση: {{post['address']}}. Περιγραφη: {{post['description']}}. Διαθεσιμο για αναλαβη. </p>
        </div>
        <div class="col">
      <form method="post" action="{{url_for('reports.take', id = post['id'])}}">
      <input id="take"type="submit" class="btn btn-primary" value="Take">
      </form>
      </div>
      </div>
    </li>
  {% endfor %}
  </ul>
  <div class="d-flex justify-content-center">
    <h3>Αναφορες υπο αναλαβη</h3>
    </div>
  <ul class="list=group" id="taken">

  {% for post in poststaken %}
    <li class="list-group-item rounded">
      <div class="row">
      <div class="col-8">
      <p>Τυπος βλαβης: {{ post['type'] }}. Περιοχη: {{post['region']}}. Υποπεριοχη: {{post['area']}}. Διευθυνση: {{post['address']}}. Περιγραφη: {{post['description']}}. Αναλαβη απο: {{post['username']}}</p>
      </div>
      {% if post['takenby'] == g.user['id'] %}
      <div class="col-2">
      <form method="post" action="{{url_for('reports.delete', id = post['id'])}}">
      <input type="submit" class="btn btn-danger" value="Delete">
      </form>
      </div>
      <div class="col-2">
      <form method="post" action="{{url_for('reports.undo', id = post['id'])}}">
      <input type="submit" class="btn btn-info" value="Undo">
      </form>
      </div>
      {% endif %}
      </div>
    </li>
  {% endfor %}
  </ul>
  </div>


{% endblock %}
